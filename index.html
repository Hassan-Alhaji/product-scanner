<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Smart Product Scanner</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root { --primary:#4a90e2; --primary-dark:#3a7ac6; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Cairo',sans-serif;background:linear-gradient(135deg,#d5e9ff 0%,#fcfcfc 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:16px;text-align:center}
    .container{width:100%;max-width:520px;background:#fff;border-radius:18px;box-shadow:0 8px 22px rgba(0,0,0,.08);padding:28px 20px 36px}
    h2{margin:0;color:#222}
    small{display:block;color:#999;font-size:.6rem;margin-top:8px}
    video,#preview{width:100%;border-radius:14px;margin:18px 0;display:none;background:#f2f2f2}
    .btn-group{display:flex;justify-content:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    button{padding:10px 20px;border:none;border-radius:8px;background:var(--primary);color:#fff;font-size:1rem;cursor:pointer;transition:background .3s}
    button:hover{background:var(--primary-dark)}
    #productData{display:none;background:#f4f9ff;padding:16px;border-radius:14px}
    #productData p{margin:8px 0 4px;color:#444;font-weight:600}
    input{width:92%;padding:8px 12px;border:1px solid #ccc;border-radius:6px;margin-bottom:10px;text-align:center;font-family:inherit}
    .quantity-control{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:10px}
    .quantity-control button{width:40px;height:40px;font-size:1.2rem;padding:0}
    .quantity-control span{font-size:1rem;font-weight:600;width:50px;text-align:center}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>Smart Product Scanner</h2>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    <img id="preview" alt="Image Preview" />

    <div class="btn-group" id="cameraButtons">
      <button id="startCamera">Start Camera</button>
      <button id="capture" style="display:none">Capture Image</button>
    </div>
    <small>version-015</small>

    <div id="productData">
      <p>Description</p><input id="description" type="text" />
      <p>Color</p><input id="color" type="text" />
      <p>Size</p><input id="size" type="text" />
      <p>Brand</p><input id="brand" type="text" />
      <p>Quantity</p>
      <div class="quantity-control">
        <button id="decreaseQty">-</button>
        <span id="quantity">1</span>
        <button id="increaseQty">+</button>
      </div>
      <div class="btn-group">
        <button id="saveNext">Save and Add Another</button>
        <button id="saveFinish">Save and Finish</button>
      </div>
    </div>
  </div>

<script>
const video         = document.getElementById('video');
const canvas        = document.getElementById('canvas');
const preview       = document.getElementById('preview');
const startBtn      = document.getElementById('startCamera');
const captureBtn    = document.getElementById('capture');
const productDiv    = document.getElementById('productData');
const descInput     = document.getElementById('description');
const colorInput    = document.getElementById('color');
const sizeInput     = document.getElementById('size');
const brandInput    = document.getElementById('brand');
const qtyDisplay    = document.getElementById('quantity');
const decreaseQtyBtn= document.getElementById('decreaseQty');
const increaseQtyBtn= document.getElementById('increaseQty');
const saveNextBtn   = document.getElementById('saveNext');
const saveFinishBtn = document.getElementById('saveFinish');

let stream;
const products = [];
let quantity = 1;

async function activateCamera() {
  try {
    if (!stream) {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
    }
    video.style.display = 'block';
    captureBtn.style.display = 'inline-block';
    startBtn.style.display = 'none';
  } catch (e) {
    alert('Failed to start camera: ' + e.message);
  }
}

function clearForm() {
  descInput.value = colorInput.value = sizeInput.value = brandInput.value = '';
  quantity = 1;
  qtyDisplay.textContent = quantity;
}

function resetForNext() {
  preview.style.display = 'none';
  productDiv.style.display = 'none';
  captureBtn.style.display = 'none';
  startBtn.style.display = 'inline-block';
  startBtn.textContent = 'Add New Product';
  video.style.display = 'none';
  clearForm();
}

startBtn.addEventListener('click', activateCamera);

captureBtn.addEventListener('click', () => {
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  preview.src = canvas.toDataURL('image/jpeg');
  preview.style.display = 'block';
  video.style.display = 'none';
  productDiv.style.display = 'block';
});

decreaseQtyBtn.addEventListener('click', () => {
  if (quantity > 1) {
    quantity--;
    qtyDisplay.textContent = quantity;
  }
});

increaseQtyBtn.addEventListener('click', () => {
  quantity++;
  qtyDisplay.textContent = quantity;
});

function pushProduct() {
  products.push({
    'Description': descInput.value,
    'Color'      : colorInput.value,
    'Size'       : sizeInput.value,
    'Brand'      : brandInput.value,
    'Quantity'   : quantity,
    'ImageLink'  : preview.src  // <-- رابط الصورة
  });
}

function downloadExcel() {
  if (products.length === 0) {
    alert('No products recorded');
    return;
  }

  /*  تحويل البيانات للورقة بما فيها رابط الصورة */
  const ws = XLSX.utils.json_to_sheet(products);

  /*  وضع الروابط كـ Hyperlink لتسهيل فتحها من الإكسل */
  products.forEach((p, idx) => {
    const cellAddress = XLSX.utils.encode_cell({ r: idx + 1, c: 6 }); // الصف +1 لعنوان الجدول، العمود السابع (F = 5, G = 6)
    if (!ws[cellAddress]) ws[cellAddress] = { t: 's', v: 'Image' };
    ws[cellAddress].l = { Target: p.ImageLink, Tooltip: 'Open captured image' };
  });

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Products');
  XLSX.writeFile(wb, 'products.xlsx');
}

saveNextBtn.addEventListener('click', async () => {
  pushProduct();
  resetForNext();
  await activateCamera();
});

saveFinishBtn.addEventListener('click', () => {
  try {
    pushProduct();
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    downloadExcel();
    resetForNext();
  } catch (e) {
    alert('Error saving data: ' + e.message);
  }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>تطبيق مسح المنتجات الذكي</title>

  <!--  ❖  الخطوط و التنسيق  -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: #4a90e2;
      --primary-dark: #3a7ac6;
      --background: linear-gradient(135deg, #d5e9ff 0%, #fcfcfc 100%);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Cairo", sans-serif;
      background: var(--background);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      text-align: center;
    }
    .container {
      width: 100%;
      max-width: 520px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 22px rgba(0, 0, 0, 0.08);
      padding: 28px 20px 36px;
    }
    h2 { margin: 0; color: #222; }
    small.version { display: block; color: #999; font-size: 0.6rem; margin-top: 12px; }

    video,
    #preview {
      width: 100%;
      border-radius: 14px;
      margin: 18px 0;
      display: none;
      background: #f2f2f2;
    }
    .btn-group {
      display: flex; justify-content: center; flex-wrap: wrap; gap: 12px; margin-bottom: 10px;
    }
    button {
      padding: 10px 22px;
      border: none; border-radius: 8px;
      background: var(--primary); color: #fff; font-size: 1rem; cursor: pointer;
      transition: background 0.25s;
    }
    button:hover { background: var(--primary-dark); }

    #loader { display: none; margin: 20px auto; border: 4px solid #e4e4e4; border-radius: 50%; border-top: 4px solid var(--primary); width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    #productData {
      display: none; background: #f4f9ff; padding: 16px; border-radius: 14px;
    }
    #productData p { margin: 8px 0 4px; color: #444; font-weight: 600; }
    input {
      width: 92%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; text-align: center; font-family: inherit;
    }
    #downloadLink { display: none; margin-top: 20px; color: var(--primary-dark); text-decoration: underline; }
  </style>

  <!--  ❖  مكتبة SheetJS (ضع الملف محلياً بجانب HTML لضمان العمل بدون إنترنت)  -->
  <script src="./xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>تطبيق مسح المنتجات الذكي</h2>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="preview" alt="معاينة الصورة" />
    <div id="loader"></div>

    <div class="btn-group">
      <button id="startCamera">تشغيل الكاميرا</button>
      <button id="capture" style="display:none;">التقاط الصورة</button>
      <button id="retake" style="display:none;">إعادة التصوير</button>
    </div>

    <small class="version">version-005</small>

    <div id="productData">
      <p>الوصف</p><input id="description" type="text" value="" />
      <p>اللون</p><input id="color" type="text" value="" />
      <p>الحجم</p><input id="size" type="text" value="" />
      <p>العلامة التجارية</p><input id="brand" type="text" value="" />
      <p>الكمية</p><input id="quantity" type="number" min="1" value="1" />
      <div class="btn-group">
        <button id="confirm">حفظ</button>
        <button id="edit" style="display:none;">تعديل</button>
      </div>
    </div>

    <button id="nextProduct" style="display:none;">المنتج التالي</button>
    <button id="finish" style="display:none;">إنهاء وحفظ Excel</button>
    <a id="downloadLink" href="#">تحميل ملف Excel</a>
  </div>

<script>
  // عناصر DOM
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const preview = document.getElementById('preview');
  const loader = document.getElementById('loader');
  const startBtn = document.getElementById('startCamera');
  const captureBtn = document.getElementById('capture');
  const retakeBtn = document.getElementById('retake');
  const productDataDiv = document.getElementById('productData');
  const descriptionInput = document.getElementById('description');
  const colorInput = document.getElementById('color');
  const sizeInput = document.getElementById('size');
  const brandInput = document.getElementById('brand');
  const quantityInput = document.getElementById('quantity');
  const confirmBtn = document.getElementById('confirm');
  const nextProductBtn = document.getElementById('nextProduct');
  const finishBtn = document.getElementById('finish');
  const downloadLink = document.getElementById('downloadLink');

  let stream;
  const products = [];

  /* === تشغيل الكاميرا === */
  startBtn.addEventListener('click', async () => {
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
      video.style.display = 'block';
      startBtn.style.display = 'none';
      captureBtn.style.display = 'inline-block';
    } catch (err) {
      alert('خطأ في تشغيل الكاميرا: ' + err.message);
    }
  });

  /* === التقاط الصورة === */
  captureBtn.addEventListener('click', () => {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    preview.src = canvas.toDataURL('image/jpeg', 0.8);
    preview.style.display = 'block';

    // إخفاء / إظهار الأزرار
    video.style.display = 'none';
    captureBtn.style.display = 'none';
    retakeBtn.style.display = 'inline-block';

    // تحليل مبسّط للون السائد (متوسط RGB)
    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    let r = 0, g = 0, b = 0, count = imgData.length / 4;
    for (let i = 0; i < imgData.length; i += 4) {
      r += imgData[i];
      g += imgData[i+1];
      b += imgData[i+2];
    }
    r = Math.round(r / count); g = Math.round(g / count); b = Math.round(b / count);
    colorInput.value = rgbToName(r, g, b);

    // إظهار بيانات المنتج لتعديلها يدويًا
    productDataDiv.style.display = 'block';
  });

  /* === إعادة التصوير === */
  retakeBtn.addEventListener('click', () => {
    preview.style.display = 'none';
    retakeBtn.style.display = 'none';
    productDataDiv.style.display = 'none';
    video.style.display = 'block';
    captureBtn.style.display = 'inline-block';
  });

  /* === حفظ المنتج الحالي === */
  confirmBtn.addEventListener('click', () => {
    saveProduct();
    productDataDiv.style.display = 'none';
    nextProductBtn.style.display = 'inline-block';
    finishBtn.style.display = 'inline-block';
    retakeBtn.style.display = 'none';
  });

  /* === الانتقال لمنتج جديد === */
  nextProductBtn.addEventListener('click', () => {
    preview.style.display = 'none';
    nextProductBtn.style.display = 'none';
    finishBtn.style.display = 'none';
    video.style.display = 'block';
    captureBtn.style.display = 'inline-block';
  });

  /* === إنهاء وحفظ Excel === */
  finishBtn.addEventListener('click', () => {
    if (stream) stream.getTracks().forEach(t => t.stop());
    const ws = XLSX.utils.json_to_sheet(products);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Products');
    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
    const blob = new Blob([wbout], { type: 'application/octet-stream' });
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = 'products.xlsx';
    downloadLink.style.display = 'block';
  });

  function saveProduct() {
    products.push({
      'الوصف': descriptionInput.value,
      '
<!-- تعديل مكان رقم النسخة -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>تطبيق مسح المنتجات الذكي</title>

  <!-- ===== FONTS & CSS ===== -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary: #4a90e2;
      --primary-dark: #3a7ac6;
      --background: linear-gradient(135deg, #d9ebff 0%, #fefefe 100%);
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: "Cairo", sans-serif;
      background: var(--background);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 15px;
    }
    .container {
      width: 100%;
      max-width: 520px;
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
      padding: 30px 22px 40px;
      position: relative;
    }
    h2 {
      color: #222;
      margin: 0;
    }
    small.version {
      display: block;
      color: #999;
      font-size: 0.65rem;
      margin-top: 12px;
    }
    video,
    #preview {
      width: 100%;
      border-radius: 14px;
      margin: 18px 0;
      display: none;
      background: #f2f2f2;
    }
    .btn-group {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 22px;
      border: none;
      border-radius: 8px;
      background: var(--primary);
      color: #ffffff;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.25s;
    }
    button:hover {
      background: var(--primary-dark);
    }
    #loader,
    #modelLoader {
      display: none;
      margin: 22px auto;
      border: 4px solid #e4e4e4;
      border-radius: 50%;
      border-top: 4px solid var(--primary);
      width: 42px;
      height: 42px;
      animation: spin 0.9s linear infinite;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    #productData {
      display: none;
      background: #f4f9ff;
      padding: 18px 14px;
      border-radius: 14px;
    }
    #productData p {
      margin: 10px 0 4px;
      color: #444;
      font-weight: 600;
    }
    input {
      padding: 8px 12px;
      width: 92%;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      font-family: inherit;
      text-align: center;
    }
    #downloadLink {
      display: none;
      margin-top: 20px;
      color: var(--primary-dark);
      text-decoration: underline;
    }
    #toast {
      position: fixed;
      bottom: 20px;
      right: 50%;
      transform: translateX(50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.85rem;
      display: none;
      z-index: 999;
    }
  </style>

  <!-- ===== LIBS ===== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
</head>
<body>
  <div id="toast"></div>
  <div class="container">
    <h2>تطبيق مسح المنتجات الذكي</h2>

    <!-- MODEL LOADER INDICATOR -->
    <div id="modelLoader"></div>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display: none"></canvas>
    <img id="preview" alt="معاينة الصورة" crossorigin="anonymous" />
    <div id="loader"></div>

    <div class="btn-group">
      <button id="startCamera">تشغيل الكاميرا</button>
      <button id="capture" style="display: none">التقاط الصورة</button>
      <button id="retake" style="display: none">إعادة التصوير</button>
    </div>

    <small class="version">version-004</small>

    <!-- باقي المحتوى كما هو بدون تغيير -->

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>تطبيق مسح المنتجات الذكي</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root { --primary:#4a90e2; --primary-dark:#3a7ac6; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Cairo',sans-serif;background:linear-gradient(135deg,#d5e9ff 0%,#fcfcfc 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:16px;text-align:center}
    .container{width:100%;max-width:520px;background:#fff;border-radius:18px;box-shadow:0 8px 22px rgba(0,0,0,.08);padding:28px 20px 36px}
    h2{margin:0;color:#222}
    small.version{display:block;color:#999;font-size:.6rem;margin-top:8px}
    video,#preview{width:100%;border-radius:14px;margin:18px 0;display:none;background:#f2f2f2}
    .btn-group{display:flex;justify-content:center;gap:10px;margin-bottom:16px;flex-wrap:wrap}
    button{padding:10px 20px;border:none;border-radius:8px;background:var(--primary);color:#fff;font-size:1rem;cursor:pointer;transition:background .3s}
    button:hover{background:var(--primary-dark)}
    #productData{display:none;background:#f4f9ff;padding:16px;border-radius:14px}
    #productData p{margin:8px 0 4px;color:#444;font-weight:600}
    input{width:92%;padding:8px 12px;border:1px solid #ccc;border-radius:6px;margin-bottom:10px;text-align:center;font-family:inherit}
  </style>
  <script src="./xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h2>تطبيق مسح المنتجات الذكي</h2>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>
    <img id="preview" alt="معاينة الصورة" />

    <div class="btn-group" id="cameraButtons">
      <button id="startCamera">تشغيل الكاميرا</button>
      <button id="capture" style="display:none">التقاط الصورة</button>
    </div>
    <small class="version">version-009</small>

    <div id="productData">
      <p>الوصف</p><input id="description" type="text" />
      <p>اللون</p><input id="color" type="text" />
      <p>الحجم</p><input id="size" type="text" />
      <p>العلامة التجارية</p><input id="brand" type="text" />
      <p>الكمية</p><input id="quantity" type="number" min="1" value="1" />
      <div class="btn-group">
        <button id="saveNext">حفظ وإضافة منتج آخر</button>
        <button id="saveFinish">حفظ وإنهاء العمل</button>
      </div>
    </div>
  </div>

<script>
const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const preview=document.getElementById('preview');
const startBtn=document.getElementById('startCamera');
const captureBtn=document.getElementById('capture');
const productDiv=document.getElementById('productData');
const descInput=document.getElementById('description');
const colorInput=document.getElementById('color');
const sizeInput=document.getElementById('size');
const brandInput=document.getElementById('brand');
const qtyInput=document.getElementById('quantity');
const saveNextBtn=document.getElementById('saveNext');
const saveFinishBtn=document.getElementById('saveFinish');
const cameraButtons=document.getElementById('cameraButtons');

let stream;const products=[];

async function activateCamera(){ try{ if(!stream){stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}); video.srcObject=stream;} video.style.display='block'; captureBtn.style.display='inline-block'; startBtn.style.display='none'; }catch(e){alert('تعذر تشغيل الكاميرا: '+e.message);} }

function resetFields(){descInput.value=colorInput.value=sizeInput.value=brandInput.value="";qtyInput.value=1;}
function resetForNext(){preview.style.display='none';productDiv.style.display='none';captureBtn.style.display='none';startBtn.style.display='inline-block';startBtn.textContent='إضافة منتج جديد';video.style.display='none';resetFields();}

startBtn.addEventListener('click',activateCamera);

captureBtn.addEventListener('click',()=>{canvas.width=video.videoWidth;canvas.height=video.videoHeight;canvas.getContext('2d').drawImage(video,0,0);preview.src=canvas.toDataURL('image/jpeg');preview.style.display='block';video.style.display='none';productDiv.style.display='block';});

function pushProduct(){products.push({'الوصف':descInput.value,'اللون':colorInput.value,'الحجم':sizeInput.value,'العلامة التجارية':brandInput.value,'الكمية':qtyInput.value,'الصورة':preview.src});}

function downloadExcel(){const ws=XLSX.utils.json_to_sheet(products);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Products');const wbout=XLSX.write(wb,{bookType:'xlsx',type:'array'});const blob=new Blob([wbout],{type:'application/octet-stream'});const link=document.createElement('a');link.href=URL.createObjectURL(blob);link.download='products.xlsx';document.body.appendChild(link);link.click();setTimeout(()=>{URL.revokeObjectURL(link.href);link.remove();},0);}

saveNextBtn.addEventListener('click',async()=>{pushProduct();resetForNext();await activateCamera();});

saveFinishBtn.addEventListener('click',()=>{pushProduct();if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}downloadExcel();resetForNext();});
</script>
</body>
</html>
